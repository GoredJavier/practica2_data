---
title: "Práctica AE2"
author: "Grupo 1"
date: "`r format(Sys.time(), '%d-%m-%Y')`"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
    
---

```{r carga_librerias, include=FALSE}
library(readr)
library(stringr)
library(swirl)
library(RCurl)
library(XML)
library(httr)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(DT)

```

# Autores

**Práctica:** Actividad Evaluable 2  
**Asignatura:** Data Driven Security  
**Fecha:** `r format(Sys.time(), '%d-%m-%Y')`  


|Grupo 1 |  
|:--------|  
|Javier Gómez Rodríguez|  
|Fernando Palma Villanueva|  
|Mireia Náger Piazuelo| 


# 1. Datos elegantes + Análisis de datos con web scrapping

## Pregunta 1

```{r descarga_pagina, include=FALSE,cache=TRUE}
base_domain <- "https://www.mediawiki.org"
html <- GET("https://www.mediawiki.org")
content <- content(html, as = "text")
parsedHtml <- htmlParse(content, asText = TRUE)
print(parsedHtml)
```


```{r extrae_contenido, include=FALSE, cache=TRUE}
 title <- xpathSApply(parsedHtml, "//title", xmlValue)
 texts <- xpathSApply(parsedHtml, "//p", xmlValue)
 links_text <- xpathSApply(parsedHtml, "//a", xmlValue)
 links_url  <- xpathSApply(parsedHtml, "//a", xmlGetAttr, 'href')
```


```{r define_functions, include=FALSE}

categoria_url <- function(url) {
  if (startsWith(url, "//")) {
    return("Subdominio")
  }
  else if (startsWith(url, "/")) {
    return("Relativa")
  }
  else if (startsWith(url, "#")) {
    return("Relativa")
  }
  else if (startsWith(url, "https") || startsWith(url, "http"))  {
    return("Absoluta")
  }
}

convertir_absoluta <- function(url) {
  if (startsWith(url, "//"))  {
    return(paste("https:", url, sep = ""))
  }
  else if (startsWith(url, "/") || startsWith(url, "#")) {
    return(paste(base_domain, url, sep = ""))
  }
  else if (startsWith(url, "https") || startsWith(url, "http"))  {
    return(url)
  }
}

get_status <- function(url) {
  html_head <- HEAD(convertir_absoluta(url))
  return(html_head$status_code)

}

```


```{r crea_df, include=FALSE, cache=TRUE}
df <- data.frame(
  url_relativa = links_url,
  texto = links_text,
  url_absoluta = sapply(links_url, convertir_absoluta),
  tipo_url = sapply(links_url, categoria_url),
  estado = sapply(links_url, get_status)
)
df <- left_join(df, count(df, url_relativa), by = "url_relativa")


```


```{r imprime_tabla_resumen }

resumen_title <- c("Cabcera: ", title)
resumen_tabla <- data.frame(
  Enlace = df$url_relativa,
  Texto = df$texto,
  Visto = df$n,
  Estado = df$estado
)

print(paste("Cabecera: ",title))
datatable(resumen_tabla)

```




## Pregunta 2

### 1. Tipos de Urls
Histograma con la frecuencia de aparición de los enlaces, separando en URLs absolutas, relativas y subdominios.


```{r imprimir_histograma}

#Se utiliza la función ggplot y geom_bar para mostrar un histográma con valores discretos
ggplot(df,aes(tipo_url,tipo_url))+geom_bar(stat="identity",width=1)

```

### 2. Dominios mediawiki
Gráfico de barras que indica la suma de enlaces que apuntan a otros dominios o servicios (distinto a https://www.mediawiki.org) vs. la suma de otros enlaces. 

```{r imprimir_barplot}

#Se calculan las ocurrencias de urls a mediawiki y a otras urls 
v_urls <- c(length(which(grepl("https://www.mediawiki.org", df$url_absoluta, fixed=FALSE))),length(which(!grepl("https://www.mediawiki.org", df$url_absoluta, fixed=FALSE))))

bar_names <- c("Urls mediawiki", "Otras urls") 

#Se utiliza la función barplot para mostrar el gráfico de barras
barplot(height = v_urls, names.arg=bar_names,col = "skyblue", main = "Tipos de URLs")

```

### 3. Porcentajes de status 
Gráfico de tarta indicando los porcentajes de Status del análisis 

```{r imprimir_piechart}

total_estados = length(df$estado)
tipos_estados <- c("200","404")

valores_pie <- c(length(which(grepl("200", df$estado,fixed=FALSE)))/total_estados,
                 length(which(grepl("404", df$estado, fixed=FALSE)))/total_estados)

pie(valores_pie, labels = tipos_estados, col="skyblue", main="Porcentaje de Status")


```